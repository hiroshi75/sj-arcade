<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dusty Trails - Sheriff Jim's Retro Arcade</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0a0a;
            min-height: 100vh;
            font-family: 'Press Start 2P', cursive;
            color: #33ff33;
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        #game-container {
            width: 100%;
            max-width: 900px;
            background: #111;
            border: 4px solid #33ff33;
            box-shadow: 0 0 20px rgba(51, 255, 51, 0.3), inset 0 0 100px rgba(0,0,0,0.5);
            padding: 20px;
            position: relative;
        }
        /* CRT effect */
        #game-container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(0,0,0,0.1) 0px,
                rgba(0,0,0,0.1) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
        }
        header {
            text-align: center;
            border-bottom: 2px solid #33ff33;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        header h1 {
            font-size: 24px;
            color: #ffcc00;
            text-shadow: 2px 2px #8B4513;
            margin-bottom: 5px;
        }
        header .subtitle {
            font-size: 10px;
            color: #33ff33;
        }
        /* Stats bar */
        #stats-bar {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            padding: 10px;
            background: #1a1a1a;
            border: 2px solid #33ff33;
            margin-bottom: 15px;
            font-size: 10px;
        }
        #stats-bar.visible { display: grid; }
        .stat-value.rep-good { color: #33ff33; }
        .stat-value.rep-bad { color: #ff3333; }
        .stat-value.rep-neutral { color: #ffcc00; }
        .stat { display: flex; justify-content: space-between; }
        .stat-label { color: #999; }
        .stat-value { color: #ffcc00; }
        .stat-value.hp { color: #ff3333; }
        .stat-value.gold { color: #ffcc00; }
        /* Main content */
        #story-area {
            min-height: 300px;
            padding: 15px;
            background: #0a0a0a;
            border: 1px solid #333;
            margin-bottom: 15px;
            font-size: 11px;
            line-height: 1.8;
            overflow-y: auto;
            max-height: 400px;
        }
        #story-area p { margin-bottom: 15px; }
        #story-area .narrator { color: #33ff33; }
        #story-area .dialogue { color: #ffcc00; font-style: italic; }
        #story-area .system { color: #ff6600; }
        #story-area .combat { color: #ff3333; }
        #story-area .loot { color: #00ffff; }
        #story-area .choice-result { color: #ff66ff; }
        /* Choices */
        #choices-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .choice-btn {
            background: #1a1a1a;
            border: 2px solid #33ff33;
            color: #33ff33;
            padding: 12px 15px;
            font-family: 'Press Start 2P', cursive;
            font-size: 10px;
            text-align: left;
            cursor: pointer;
            transition: all 0.1s;
        }
        .choice-btn:hover {
            background: #33ff33;
            color: #0a0a0a;
        }
        .choice-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .choice-btn .key {
            color: #ffcc00;
            margin-right: 10px;
        }
        .choice-btn:hover .key { color: #0a0a0a; }
        /* Character creation */
        #char-create {
            text-align: center;
        }
        #char-create h2 {
            color: #ffcc00;
            font-size: 14px;
            margin-bottom: 20px;
        }
        #char-create input {
            background: #1a1a1a;
            border: 2px solid #33ff33;
            color: #33ff33;
            padding: 10px;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            width: 100%;
            max-width: 300px;
            margin-bottom: 20px;
            text-align: center;
        }
        #char-create input::placeholder { color: #555; }
        .class-select {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .class-card {
            background: #1a1a1a;
            border: 2px solid #555;
            padding: 15px;
            cursor: pointer;
            transition: all 0.1s;
        }
        .class-card:hover, .class-card.selected {
            border-color: #ffcc00;
            box-shadow: 0 0 10px rgba(255, 204, 0, 0.3);
        }
        .class-card .icon { font-size: 32px; margin-bottom: 10px; }
        .class-card .name { color: #ffcc00; font-size: 12px; margin-bottom: 8px; }
        .class-card .desc { color: #999; font-size: 8px; line-height: 1.6; }
        .class-card .stats-preview { color: #33ff33; font-size: 8px; margin-top: 10px; }
        /* Combat UI */
        #combat-area {
            display: none;
            background: #1a0a0a;
            border: 2px solid #ff3333;
            padding: 15px;
            margin-bottom: 15px;
        }
        #combat-area.visible { display: block; }
        .combat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 12px;
        }
        .combatant {
            text-align: center;
        }
        .combatant .name { color: #ffcc00; margin-bottom: 5px; }
        .combatant .hp-bar {
            width: 150px;
            height: 15px;
            background: #333;
            border: 1px solid #ff3333;
            margin: 0 auto;
        }
        .combatant .hp-fill {
            height: 100%;
            background: #ff3333;
            transition: width 0.3s;
        }
        .combatant .hp-text { font-size: 10px; color: #ff3333; margin-top: 5px; }
        .vs { color: #ff3333; font-size: 20px; }
        #combat-log {
            background: #0a0a0a;
            padding: 10px;
            font-size: 9px;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        #combat-log p { margin: 5px 0; }
        /* Inventory */
        #inventory {
            display: none;
            background: #1a1a0a;
            border: 2px solid #ffcc00;
            padding: 15px;
            margin-bottom: 15px;
        }
        #inventory.visible { display: block; }
        #inventory h3 { color: #ffcc00; font-size: 12px; margin-bottom: 10px; }
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }
        .item-slot {
            background: #0a0a0a;
            border: 1px solid #555;
            padding: 10px;
            text-align: center;
            font-size: 8px;
        }
        .item-slot .item-icon { font-size: 24px; margin-bottom: 5px; }
        .item-slot .item-name { color: #ffcc00; }
        .item-slot .item-qty { color: #33ff33; }
        /* Game over */
        #game-over {
            display: none;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 100;
        }
        #game-over.visible { display: flex; }
        #game-over h1 { color: #ff3333; font-size: 24px; margin-bottom: 20px; }
        #game-over.victory h1 { color: #ffcc00; }
        #game-over p { color: #999; font-size: 10px; margin: 10px 0; }
        #game-over .final-stats { color: #33ff33; margin: 20px 0; }
        .restart-btn {
            background: #33ff33;
            color: #0a0a0a;
            border: none;
            padding: 15px 30px;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            cursor: pointer;
            margin-top: 20px;
        }
        .restart-btn:hover { background: #66ff66; }
        /* Dice roll animation */
        .dice-roll {
            display: inline-block;
            animation: shake 0.3s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-5deg); }
            75% { transform: translateX(5px) rotate(5deg); }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <header>
            <h1>üåµ DUSTY TRAILS üåµ</h1>
            <div class="subtitle">A Western Text Adventure</div>
        </header>
        
        <div id="stats-bar">
            <div class="stat"><span class="stat-label">HP</span><span class="stat-value hp" id="hp">--</span></div>
            <div class="stat"><span class="stat-label">STR</span><span class="stat-value" id="str">--</span></div>
            <div class="stat"><span class="stat-label">DEX</span><span class="stat-value" id="dex">--</span></div>
            <div class="stat"><span class="stat-label">LCK</span><span class="stat-value" id="lck">--</span></div>
            <div class="stat"><span class="stat-label">GOLD</span><span class="stat-value gold" id="gold">--</span></div>
            <div class="stat"><span class="stat-label">REP</span><span class="stat-value rep-neutral" id="rep">--</span></div>
        </div>
        
        <div id="combat-area">
            <div class="combat-header">
                <div class="combatant player">
                    <div class="name" id="player-name">Player</div>
                    <div class="hp-bar"><div class="hp-fill" id="player-hp-bar"></div></div>
                    <div class="hp-text"><span id="player-hp-text">--</span> HP</div>
                </div>
                <div class="vs">‚öîÔ∏è</div>
                <div class="combatant enemy">
                    <div class="name" id="enemy-name">Enemy</div>
                    <div class="hp-bar"><div class="hp-fill" id="enemy-hp-bar"></div></div>
                    <div class="hp-text"><span id="enemy-hp-text">--</span> HP</div>
                </div>
            </div>
            <div id="combat-log"></div>
        </div>
        
        <div id="inventory">
            <h3>üéí INVENTORY</h3>
            <div class="inventory-grid" id="inventory-grid"></div>
        </div>
        
        <div id="story-area"></div>
        
        <div id="choices-area"></div>
        
        <div id="game-over">
            <h1 id="go-title">GAME OVER</h1>
            <p id="go-message"></p>
            <div class="final-stats" id="go-stats"></div>
            <button class="restart-btn" onclick="startGame()">‚ñ∂ NEW GAME</button>
        </div>
    </div>
    
    <script>
        // === SOUND SYSTEM ===
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;
        
        function initAudio() {
            if (!audioCtx) audioCtx = new AudioCtx();
        }
        
        function playSound(type) {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            switch(type) {
                case 'gunshot':
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.1);
                    break;
                case 'coin':
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                    osc.frequency.setValueAtTime(1200, audioCtx.currentTime + 0.1);
                    gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.2);
                    break;
                case 'hit':
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(80, audioCtx.currentTime + 0.15);
                    gain.gain.setValueAtTime(0.25, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.15);
                    break;
                case 'victory':
                    [523, 659, 784].forEach((freq, i) => {
                        const o = audioCtx.createOscillator();
                        const g = audioCtx.createGain();
                        o.connect(g); g.connect(audioCtx.destination);
                        o.type = 'sine';
                        o.frequency.value = freq;
                        g.gain.setValueAtTime(0.15, audioCtx.currentTime + i * 0.15);
                        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i * 0.15 + 0.3);
                        o.start(audioCtx.currentTime + i * 0.15);
                        o.stop(audioCtx.currentTime + i * 0.15 + 0.3);
                    });
                    break;
                case 'death':
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(300, audioCtx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.5);
                    gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.5);
                    break;
                case 'click':
                    osc.type = 'sine';
                    osc.frequency.value = 600;
                    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.05);
                    break;
            }
        }
        
        // Game state
        let player = null;
        let currentScene = null;
        let gameDay = 1;
        let enemies = [];
        let inCombat = false;
        let currentEnemy = null;
        
        // Character classes with special abilities
        const CLASSES = {
            gunslinger: {
                name: 'Gunslinger',
                icon: 'üî´',
                desc: 'Fast and deadly. Lives by the gun.',
                hp: 80, str: 12, dex: 14, lck: 8,
                startItems: ['revolver', 'bullets_12'],
                special: { name: 'Fan the Hammer', desc: '3 rapid shots (3x damage)', cooldown: 3, dmgMult: 3 }
            },
            sheriff: {
                name: 'Sheriff',
                icon: '‚≠ê',
                desc: 'Tough and righteous. The law of the land.',
                hp: 100, str: 10, dex: 10, lck: 10,
                startItems: ['badge', 'revolver', 'bandage'],
                special: { name: 'Stand Your Ground', desc: 'Heal 30 HP & +5 DEF this turn', cooldown: 4, heal: 30 }
            },
            outlaw: {
                name: 'Outlaw',
                icon: 'ü§†',
                desc: 'Lucky and cunning. Takes what they want.',
                hp: 70, str: 8, dex: 12, lck: 14,
                startItems: ['knife', 'lockpick', 'whiskey'],
                special: { name: 'Dirty Trick', desc: 'Stun enemy (skip their turn) + steal gold', cooldown: 3, stun: true }
            },
            prospector: {
                name: 'Prospector',
                icon: '‚õèÔ∏è',
                desc: 'Hardy and lucky. Seeking fortune.',
                hp: 90, str: 14, dex: 6, lck: 12,
                startItems: ['pickaxe', 'dynamite', 'gold_nugget'],
                special: { name: 'Dynamite Blast', desc: 'Massive explosion (50 damage)', cooldown: 5, flatDmg: 50 }
            }
        };
        
        // Items
        const ITEMS = {
            revolver: { name: 'Revolver', icon: 'üî´', type: 'weapon', damage: 15 },
            knife: { name: 'Knife', icon: 'üî™', type: 'weapon', damage: 8 },
            pickaxe: { name: 'Pickaxe', icon: '‚õèÔ∏è', type: 'weapon', damage: 12 },
            rifle: { name: 'Rifle', icon: 'üéØ', type: 'weapon', damage: 25 },
            bandage: { name: 'Bandage', icon: 'ü©π', type: 'heal', heal: 20 },
            whiskey: { name: 'Whiskey', icon: 'ü•É', type: 'heal', heal: 15, strBoost: 2 },
            dynamite: { name: 'Dynamite', icon: 'üß®', type: 'combat', damage: 40 },
            gold_nugget: { name: 'Gold Nugget', icon: '‚ú®', type: 'valuable', value: 50 },
            bullets_12: { name: 'Bullets x12', icon: 'üîò', type: 'ammo', qty: 12 },
            badge: { name: "Sheriff's Badge", icon: '‚≠ê', type: 'special', effect: 'respect' },
            lockpick: { name: 'Lockpick', icon: 'üîë', type: 'tool' },
            horse: { name: 'Horse', icon: 'üê¥', type: 'mount', speed: 2 }
        };
        
        // Enemies
        const ENEMY_TYPES = {
            bandit: { name: 'Bandit', icon: 'ü§†', hp: 40, str: 8, dex: 8, gold: 20 },
            outlaw: { name: 'Outlaw', icon: 'üòà', hp: 60, str: 12, dex: 10, gold: 40 },
            wolf: { name: 'Wild Wolf', icon: 'üê∫', hp: 30, str: 10, dex: 12, gold: 5 },
            snake: { name: 'Rattlesnake', icon: 'üêç', hp: 15, str: 15, dex: 14, gold: 0 },
            bear: { name: 'Grizzly Bear', icon: 'üêª', hp: 80, str: 18, dex: 6, gold: 10 },
            scorpion: { name: 'Giant Scorpion', icon: 'ü¶Ç', hp: 25, str: 12, dex: 16, gold: 8 },
            vulture: { name: 'Vulture Swarm', icon: 'ü¶Ö', hp: 35, str: 6, dex: 18, gold: 3 },
            coyote: { name: 'Coyote Pack', icon: 'üêï', hp: 45, str: 9, dex: 14, gold: 12 },
            desperado: { name: 'Desperado', icon: 'üî´', hp: 70, str: 14, dex: 12, gold: 55 },
            boss_sheriff: { name: 'Corrupt Sheriff', icon: 'üëÆ', hp: 100, str: 14, dex: 12, gold: 100 },
            boss_gang: { name: 'Gang Leader', icon: 'üíÄ', hp: 120, str: 16, dex: 14, gold: 150 }
        };
        
        // DOM elements
        const storyArea = document.getElementById('story-area');
        const choicesArea = document.getElementById('choices-area');
        const statsBar = document.getElementById('stats-bar');
        const combatArea = document.getElementById('combat-area');
        const inventoryEl = document.getElementById('inventory');
        const gameOverEl = document.getElementById('game-over');
        
        // Initialize
        function startGame() {
            player = null;
            currentScene = null;
            gameDay = 1;
            inCombat = false;
            gameOverEl.classList.remove('visible', 'victory');
            statsBar.classList.remove('visible');
            combatArea.classList.remove('visible');
            inventoryEl.classList.remove('visible');
            showCharacterCreation();
        }
        
        function showCharacterCreation() {
            storyArea.innerHTML = `
                <div id="char-create">
                    <h2>üåÖ CREATE YOUR CHARACTER üåÖ</h2>
                    <p class="narrator">The year is 1885. The frontier awaits...</p>
                    <input type="text" id="char-name" placeholder="Enter your name" maxlength="12">
                    <p class="narrator">Choose your path:</p>
                    <div class="class-select">
                        ${Object.entries(CLASSES).map(([key, c]) => `
                            <div class="class-card" data-class="${key}">
                                <div class="icon">${c.icon}</div>
                                <div class="name">${c.name}</div>
                                <div class="desc">${c.desc}</div>
                                <div class="stats-preview">HP:${c.hp} STR:${c.str} DEX:${c.dex} LCK:${c.lck}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            choicesArea.innerHTML = '';
            
            // Add class selection listeners
            document.querySelectorAll('.class-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.class-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                });
            });
            
            // Add start button after a class is selected
            setTimeout(() => {
                choicesArea.innerHTML = `
                    <button class="choice-btn" onclick="createCharacter()">
                        <span class="key">[ENTER]</span> Begin Your Journey
                    </button>
                `;
            }, 500);
        }
        
        function createCharacter() {
            const nameInput = document.getElementById('char-name');
            const selectedClass = document.querySelector('.class-card.selected');
            
            if (!selectedClass) {
                addStory('system', 'Choose a class first!');
                return;
            }
            
            const className = selectedClass.dataset.class;
            const classData = CLASSES[className];
            const name = nameInput.value.trim() || 'Stranger';
            
            player = {
                name: name,
                class: className,
                classData: classData,
                hp: classData.hp,
                maxHp: classData.hp,
                str: classData.str,
                dex: classData.dex,
                lck: classData.lck,
                gold: 10,
                inventory: [...classData.startItems],
                reputation: 0,
                kills: 0,
                specialCooldown: 0
            };
            
            playSound('click');
            
            statsBar.classList.add('visible');
            updateStats();
            
            showScene('intro');
        }
        
        function updateStats() {
            document.getElementById('hp').textContent = `${player.hp}/${player.maxHp}`;
            document.getElementById('str').textContent = player.str;
            document.getElementById('dex').textContent = player.dex;
            document.getElementById('lck').textContent = player.lck;
            document.getElementById('gold').textContent = player.gold;
            
            // Reputation display
            const repEl = document.getElementById('rep');
            const repValue = player.reputation;
            repEl.textContent = repValue >= 0 ? `+${repValue}` : repValue;
            repEl.className = 'stat-value ' + (repValue > 0 ? 'rep-good' : repValue < 0 ? 'rep-bad' : 'rep-neutral');
        }
        
        function addStory(type, text) {
            const p = document.createElement('p');
            p.className = type;
            p.innerHTML = text;
            storyArea.appendChild(p);
            storyArea.scrollTop = storyArea.scrollHeight;
        }
        
        function clearStory() {
            storyArea.innerHTML = '';
        }
        
        function showChoices(choices) {
            choicesArea.innerHTML = choices.map((c, i) => `
                <button class="choice-btn" onclick="handleChoice('${c.action}')" ${c.disabled ? 'disabled' : ''}>
                    <span class="key">[${i + 1}]</span> ${c.text}
                </button>
            `).join('');
        }
        
        // Scenes
        const SCENES = {
            intro: {
                text: () => `
                    <p class="narrator">The stagecoach drops you at the edge of <span style="color:#ffcc00">DUSTY GULCH</span>, a town forgotten by civilization but not by trouble.</p>
                    <p class="narrator">You're ${player.name}, a ${player.classData.name}. The wind carries whispers of gold, danger, and opportunity.</p>
                    <p class="dialogue">"Welcome to Dusty Gulch, stranger. Watch your back."</p>
                    <p class="narrator">The dusty main street stretches before you. A saloon, general store, and sheriff's office line the road.</p>
                `,
                choices: [
                    { text: 'üç∫ Enter the Saloon', action: 'saloon' },
                    { text: 'üè™ Visit the General Store', action: 'store' },
                    { text: '‚≠ê Go to the Sheriff\'s Office', action: 'sheriff' },
                    { text: 'üåµ Head out of town', action: 'wilderness' }
                ]
            },
            saloon: {
                text: () => `
                    <p class="narrator">The saloon doors swing open. Piano music fills the smoky air. Cowboys eye you suspiciously.</p>
                    <p class="narrator">The bartender polishes a glass. <span class="dialogue">"What'll it be, stranger?"</span></p>
                    ${Math.random() < 0.3 ? `<p class="system">A rough-looking man in the corner stares at you menacingly...</p>` : ''}
                `,
                choices: () => {
                    const choices = [
                        { text: 'ü•É Buy a drink ($5)', action: 'buy_drink', disabled: player.gold < 5 },
                        { text: 'üé∞ Play poker ($10)', action: 'poker', disabled: player.gold < 10 },
                        { text: 'üëÇ Listen to rumors', action: 'rumors' },
                        { text: 'üö™ Leave', action: 'intro' }
                    ];
                    if (Math.random() < 0.3) {
                        choices.splice(2, 0, { text: '‚öîÔ∏è Confront the stranger', action: 'bar_fight' });
                    }
                    return choices;
                }
            },
            buy_drink: {
                text: () => {
                    player.gold -= 5;
                    player.hp = Math.min(player.maxHp, player.hp + 10);
                    updateStats();
                    return `
                        <p class="narrator">You slide 5 gold across the bar. The whiskey burns going down but warms your soul.</p>
                        <p class="loot">+10 HP restored</p>
                        <p class="dialogue">"You look like someone who can handle trouble,"</span> the bartender whispers. <span class="dialogue">"Word is, there's a bounty on Black Pete. $100 gold, dead or alive. He's holed up in the canyon east of here."</p>
                    `;
                },
                choices: () => [
                    { text: 'üé∞ Play poker ($10)', action: 'poker', disabled: player.gold < 10 },
                    { text: 'üëÇ Ask about Black Pete', action: 'bounty_info' },
                    { text: 'üö™ Leave the saloon', action: 'intro' }
                ]
            },
            poker: {
                text: () => {
                    const roll = rollDice(20) + Math.floor(player.lck / 2);
                    let result;
                    if (roll >= 18) {
                        player.gold += 30;
                        playSound('coin'); playSound('victory');
                        result = `<p class="loot">üéâ JACKPOT! You clean out the table! +$30 gold!</p>`;
                    } else if (roll >= 12) {
                        player.gold += 10;
                        playSound('coin');
                        result = `<p class="loot">You win the hand! +$10 gold</p>`;
                    } else if (roll >= 6) {
                        result = `<p class="narrator">You break even. The cards weren't with you today.</p>`;
                        player.gold -= 10;
                        player.gold += 10;
                    } else {
                        player.gold -= 10;
                        playSound('hit');
                        result = `<p class="combat">Bad luck! You lose $10 gold.</p>`;
                    }
                    updateStats();
                    return `
                        <p class="narrator">You sit at the poker table. Cards are dealt...</p>
                        <p class="system">üé≤ Luck roll: ${roll}</p>
                        ${result}
                    `;
                },
                choices: () => [
                    { text: 'üé∞ Play again ($10)', action: 'poker', disabled: player.gold < 10 },
                    { text: 'üö™ Leave the table', action: 'saloon' }
                ]
            },
            rumors: {
                text: () => {
                    const rumors = [
                        `"They say there's gold in Dead Man's Canyon, but nobody who goes there comes back..."`,
                        `"The sheriff ain't what he seems. Heard he's in with the gang."`,
                        `"A prospector found a huge nugget last week. He's staying at the inn, flashing it around like a fool."`,
                        `"Wolves have been attacking travelers on the north road. Be careful out there."`,
                        `"Black Pete's gang robbed the bank last month. $1000 still missing."`
                    ];
                    return `
                        <p class="narrator">You lean against the bar, listening to the chatter...</p>
                        <p class="dialogue">${rumors[Math.floor(Math.random() * rumors.length)]}</p>
                    `;
                },
                choices: () => [
                    { text: 'üëÇ Listen more', action: 'rumors' },
                    { text: 'üç∫ Buy a drink ($5)', action: 'buy_drink', disabled: player.gold < 5 },
                    { text: 'üö™ Leave', action: 'intro' }
                ]
            },
            bar_fight: {
                text: () => {
                    startCombat('bandit');
                    return `
                        <p class="narrator">You approach the stranger. He stands, hand on his holster.</p>
                        <p class="dialogue">"You got a problem, stranger?"</p>
                        <p class="combat">‚öîÔ∏è COMBAT INITIATED!</p>
                    `;
                },
                choices: []
            },
            store: {
                text: () => `
                    <p class="narrator">The general store is cramped but well-stocked. An old man peers at you from behind the counter.</p>
                    <p class="dialogue">"See anything you like? Fair prices, I promise."</p>
                `,
                choices: () => [
                    { text: 'ü©π Buy Bandage ($15)', action: 'buy_bandage', disabled: player.gold < 15 },
                    { text: 'ü•É Buy Whiskey ($10)', action: 'buy_whiskey', disabled: player.gold < 10 },
                    { text: 'üß® Buy Dynamite ($25)', action: 'buy_dynamite', disabled: player.gold < 25 },
                    { text: 'üí∞ Sell items', action: 'sell_items' },
                    { text: 'üö™ Leave', action: 'intro' }
                ]
            },
            buy_bandage: {
                text: () => {
                    player.gold -= 15;
                    player.inventory.push('bandage');
                    updateStats();
                    return `<p class="loot">You purchased a Bandage! ü©π</p>`;
                },
                choices: [
                    { text: 'üõí Buy more', action: 'store' },
                    { text: 'üö™ Leave', action: 'intro' }
                ]
            },
            buy_whiskey: {
                text: () => {
                    player.gold -= 10;
                    player.inventory.push('whiskey');
                    updateStats();
                    return `<p class="loot">You purchased Whiskey! ü•É</p>`;
                },
                choices: [
                    { text: 'üõí Buy more', action: 'store' },
                    { text: 'üö™ Leave', action: 'intro' }
                ]
            },
            buy_dynamite: {
                text: () => {
                    player.gold -= 25;
                    player.inventory.push('dynamite');
                    updateStats();
                    return `<p class="loot">You purchased Dynamite! üß®</p>`;
                },
                choices: [
                    { text: 'üõí Buy more', action: 'store' },
                    { text: 'üö™ Leave', action: 'intro' }
                ]
            },
            sheriff: {
                text: () => {
                    const hasBadge = player.inventory.includes('badge');
                    return `
                        <p class="narrator">The sheriff's office is quiet. Wanted posters line the walls.</p>
                        ${hasBadge ? `<p class="narrator">The deputy recognizes your badge. <span class="dialogue">"A fellow lawman! Welcome!"</span></p>` : ''}
                        <p class="narrator">BOUNTIES:</p>
                        <p class="system">üéØ Black Pete - $100 (Dangerous outlaw)</p>
                        <p class="system">üéØ Wolf Pack - $30 (Clear the north road)</p>
                        <p class="system">üéØ Snake Nest - $20 (Desert cleanup)</p>
                    `;
                },
                choices: [
                    { text: 'üéØ Hunt Black Pete', action: 'bounty_pete' },
                    { text: 'üê∫ Hunt the Wolf Pack', action: 'bounty_wolves' },
                    { text: 'üêç Clear the Snake Nest', action: 'bounty_snakes' },
                    { text: 'üö™ Leave', action: 'intro' }
                ]
            },
            wilderness: {
                text: () => {
                    const encounter = Math.random();
                    if (encounter < 0.3) {
                        return `
                            <p class="narrator">You venture into the dusty plains. The sun beats down mercilessly.</p>
                            <p class="combat">üê∫ A wild wolf appears!</p>
                        `;
                    } else if (encounter < 0.5) {
                        const goldFound = rollDice(10) + player.lck;
                        player.gold += goldFound;
                        updateStats();
                        return `
                            <p class="narrator">You wander the wilderness and find an abandoned campsite.</p>
                            <p class="loot">You found ${goldFound} gold in an old saddlebag!</p>
                        `;
                    } else {
                        return `
                            <p class="narrator">The wilderness stretches endlessly. Cacti dot the landscape.</p>
                            <p class="narrator">In the distance, you see the canyon where Black Pete is said to hide...</p>
                        `;
                    }
                },
                choices: () => {
                    if (Math.random() < 0.3) {
                        startCombat('wolf');
                        return [];
                    }
                    return [
                        { text: 'üèúÔ∏è Continue exploring', action: 'wilderness' },
                        { text: '‚õ∞Ô∏è Head to the canyon', action: 'canyon_entrance' },
                        { text: 'üè† Return to town', action: 'intro' }
                    ];
                }
            },
            canyon_entrance: {
                text: () => `
                    <p class="narrator">The canyon walls rise high above you. This is outlaw territory.</p>
                    <p class="narrator">You spot campfire smoke deeper in the canyon. Black Pete's hideout must be close.</p>
                    <p class="system">‚ö†Ô∏è WARNING: Dangerous area ahead!</p>
                `,
                choices: () => [
                    { text: 'üî´ Storm the camp', action: 'pete_fight' },
                    { text: 'ü§´ Sneak approach', action: 'pete_sneak' },
                    { text: 'üß® Use dynamite (if you have it)', action: 'pete_dynamite', disabled: !player.inventory.includes('dynamite') },
                    { text: 'üèÉ Retreat', action: 'wilderness' }
                ]
            },
            pete_fight: {
                text: () => {
                    startCombat('boss_gang');
                    return `
                        <p class="narrator">You charge into the camp, guns blazing!</p>
                        <p class="dialogue">"Who dares?!"</p> Black Pete draws his weapon.
                        <p class="combat">‚öîÔ∏è BOSS BATTLE: BLACK PETE!</p>
                    `;
                },
                choices: []
            },
            pete_sneak: {
                text: () => {
                    const roll = rollDice(20) + Math.floor(player.dex / 2);
                    if (roll >= 15) {
                        player.gold += 50;
                        updateStats();
                        return `
                            <p class="narrator">You slip through the shadows like a ghost...</p>
                            <p class="system">üé≤ Sneak roll: ${roll} - SUCCESS!</p>
                            <p class="loot">You found Pete's stash! +$50 gold!</p>
                            <p class="narrator">But Pete spots you as you leave!</p>
                        `;
                    } else {
                        return `
                            <p class="narrator">You try to sneak but step on a twig...</p>
                            <p class="system">üé≤ Sneak roll: ${roll} - FAILED!</p>
                            <p class="combat">You've been spotted!</p>
                        `;
                    }
                },
                choices: () => {
                    startCombat('boss_gang');
                    return [];
                }
            },
            pete_dynamite: {
                text: () => {
                    player.inventory = player.inventory.filter(i => i !== 'dynamite');
                    currentEnemy = {...ENEMY_TYPES.boss_gang};
                    currentEnemy.hp -= 40;
                    return `
                        <p class="narrator">You light the dynamite and hurl it into the camp!</p>
                        <p class="combat">üí• BOOM! The explosion rocks the canyon!</p>
                        <p class="loot">Black Pete takes 40 damage!</p>
                        <p class="narrator">Wounded but alive, Pete emerges from the smoke...</p>
                    `;
                },
                choices: () => {
                    startCombat('boss_gang', currentEnemy);
                    return [];
                }
            },
            bounty_wolves: {
                text: () => {
                    startCombat('wolf');
                    return `
                        <p class="narrator">You track the wolf pack to the north road...</p>
                        <p class="combat">üê∫ The alpha wolf attacks!</p>
                    `;
                },
                choices: []
            },
            bounty_snakes: {
                text: () => {
                    startCombat('snake');
                    return `
                        <p class="narrator">You find the snake nest in the desert rocks...</p>
                        <p class="combat">üêç A rattlesnake strikes!</p>
                    `;
                },
                choices: []
            },
            victory: {
                text: () => `
                    <p class="narrator">üèÜ VICTORY!</p>
                    <p class="narrator">Your name echoes through the frontier. ${player.name} the ${player.classData.name} - a legend of the West!</p>
                `,
                choices: []
            },
            ending: {
                text: () => `
                    <p class="narrator">üåÖ THE END üåÖ</p>
                    <p class="narrator">The dust settles over the canyon. Black Pete lies defeated at your feet.</p>
                    <p class="dialogue">"You... you're faster than anyone I've ever seen,"</p> he gasps.
                    <p class="narrator">Word of your victory spreads like wildfire across the frontier.</p>
                    <p class="narrator">When you return to Dusty Gulch, the townsfolk gather in the streets.</p>
                    <p class="dialogue">"Three cheers for ${player.name}!"</p> the crowd roars.
                    <p class="narrator">The mayor steps forward with a golden sheriff's star.</p>
                    <p class="dialogue">"This town owes you everything. From this day forward, you are the true law of Dusty Gulch."</p>
                    <p class="loot">üèÜ YOU ARE NOW A LEGEND OF THE WEST! üèÜ</p>
                    <p class="system">Final Stats:</p>
                    <p class="system">üí∞ Gold: ${player.gold}</p>
                    <p class="system">üíÄ Enemies Defeated: ${player.kills}</p>
                    <p class="system">‚≠ê Reputation: ${player.reputation}</p>
                    <p class="narrator">The frontier will remember your name forever...</p>
                    <p class="narrator">${player.name} the ${player.classData.name}</p>
                `,
                choices: [
                    { text: 'üîÑ Play Again', action: 'restart' }
                ]
            },
            restart: {
                text: () => { startGame(); return ''; },
                choices: []
            }
        };
        
        function showScene(sceneName) {
            currentScene = sceneName;
            const scene = SCENES[sceneName];
            if (!scene) {
                console.error('Unknown scene:', sceneName);
                return;
            }
            
            clearStory();
            const text = typeof scene.text === 'function' ? scene.text() : scene.text;
            storyArea.innerHTML = text;
            
            if (!inCombat) {
                const choices = typeof scene.choices === 'function' ? scene.choices() : scene.choices;
                if (choices && choices.length > 0) {
                    showChoices(choices);
                }
            }
        }
        
        function handleChoice(action) {
            if (SCENES[action]) {
                showScene(action);
            }
        }
        
        // Combat system
        function rollDice(sides) {
            return Math.floor(Math.random() * sides) + 1;
        }
        
        function startCombat(enemyType, existingEnemy = null) {
            inCombat = true;
            currentEnemy = existingEnemy || {...ENEMY_TYPES[enemyType]};
            currentEnemy.maxHp = currentEnemy.maxHp || currentEnemy.hp;
            
            combatArea.classList.add('visible');
            document.getElementById('player-name').textContent = player.name;
            document.getElementById('enemy-name').textContent = currentEnemy.name + ' ' + currentEnemy.icon;
            
            updateCombatUI();
            document.getElementById('combat-log').innerHTML = '';
            
            showCombatChoices();
        }
        
        function updateCombatUI() {
            const playerHpPct = (player.hp / player.maxHp) * 100;
            const enemyHpPct = (currentEnemy.hp / currentEnemy.maxHp) * 100;
            
            document.getElementById('player-hp-bar').style.width = playerHpPct + '%';
            document.getElementById('enemy-hp-bar').style.width = enemyHpPct + '%';
            document.getElementById('player-hp-text').textContent = player.hp;
            document.getElementById('enemy-hp-text').textContent = currentEnemy.hp;
            updateStats();
        }
        
        function addCombatLog(text, type = '') {
            const log = document.getElementById('combat-log');
            const p = document.createElement('p');
            p.className = type;
            p.innerHTML = text;
            log.appendChild(p);
            log.scrollTop = log.scrollHeight;
        }
        
        function showCombatChoices() {
            const hasBandage = player.inventory.includes('bandage');
            const hasWhiskey = player.inventory.includes('whiskey');
            const hasDynamite = player.inventory.includes('dynamite');
            const special = player.classData.special;
            const canUseSpecial = player.specialCooldown === 0;
            
            const choices = [
                { text: '‚öîÔ∏è Attack', action: 'combat_attack' },
                { text: 'üõ°Ô∏è Defend', action: 'combat_defend' }
            ];
            
            // Add special ability
            const specialText = canUseSpecial 
                ? `‚ö° ${special.name}` 
                : `‚ö° ${special.name} (${player.specialCooldown} turns)`;
            choices.push({ text: specialText, action: 'combat_special', disabled: !canUseSpecial });
            
            if (hasBandage) choices.push({ text: 'ü©π Use Bandage', action: 'combat_bandage' });
            if (hasWhiskey) choices.push({ text: 'ü•É Drink Whiskey', action: 'combat_whiskey' });
            if (hasDynamite) choices.push({ text: 'üß® Throw Dynamite', action: 'combat_dynamite' });
            
            showChoices(choices);
        }
        
        function playerAttack() {
            const weapon = player.inventory.find(i => ITEMS[i]?.type === 'weapon');
            const weaponDamage = weapon ? ITEMS[weapon].damage : 5;
            
            const hitRoll = rollDice(20) + Math.floor(player.dex / 3);
            const critRoll = rollDice(20);
            const isCrit = critRoll >= 18;
            
            playSound('gunshot');
            
            if (hitRoll >= 8) {
                let damage = weaponDamage + Math.floor(player.str / 2) + rollDice(6);
                if (isCrit) damage *= 2;
                
                currentEnemy.hp -= damage;
                addCombatLog(`üé≤ Hit roll: ${hitRoll} - HIT!${isCrit ? ' CRITICAL!' : ''}`, 'loot');
                addCombatLog(`You deal <span class="dice-roll">${damage}</span> damage!`, 'combat');
            } else {
                addCombatLog(`üé≤ Hit roll: ${hitRoll} - MISS!`, 'system');
            }
            
            if (player.specialCooldown > 0) player.specialCooldown--;
        }
        
        // Special ability function
        function useSpecialAbility() {
            const special = player.classData.special;
            playSound('gunshot');
            playSound('gunshot');
            
            if (special.dmgMult) {
                // Gunslinger: Fan the Hammer
                const weapon = player.inventory.find(i => ITEMS[i]?.type === 'weapon');
                const weaponDamage = weapon ? ITEMS[weapon].damage : 5;
                let damage = (weaponDamage + player.str) * special.dmgMult;
                currentEnemy.hp -= damage;
                addCombatLog(`‚ö° ${special.name}! 3 rapid shots!`, 'loot');
                addCombatLog(`üí• ${damage} total damage!`, 'combat');
            } else if (special.heal) {
                // Sheriff: Stand Your Ground
                player.hp = Math.min(player.maxHp, player.hp + special.heal);
                addCombatLog(`‚ö° ${special.name}! +${special.heal} HP restored!`, 'loot');
                playSound('coin');
            } else if (special.stun) {
                // Outlaw: Dirty Trick
                const stolenGold = Math.min(currentEnemy.gold, 10 + rollDice(10));
                player.gold += stolenGold;
                currentEnemy.stunned = true;
                addCombatLog(`‚ö° ${special.name}! Enemy stunned!`, 'loot');
                addCombatLog(`üí∞ Stole ${stolenGold} gold!`, 'loot');
                playSound('coin');
            } else if (special.flatDmg) {
                // Prospector: Dynamite Blast
                currentEnemy.hp -= special.flatDmg;
                addCombatLog(`‚ö° ${special.name}! üí• BOOM!`, 'loot');
                addCombatLog(`üß® ${special.flatDmg} explosion damage!`, 'combat');
            }
            
            player.specialCooldown = special.cooldown;
            updateStats();
        }
        
        function enemyAttack(defended = false) {
            const hitRoll = rollDice(20) + Math.floor(currentEnemy.dex / 3);
            const playerDodge = rollDice(20) + Math.floor(player.dex / 3);
            
            if (hitRoll > playerDodge) {
                let damage = currentEnemy.str + rollDice(4);
                if (defended) damage = Math.floor(damage / 2);
                
                player.hp -= damage;
                playSound('hit');
                addCombatLog(`${currentEnemy.icon} attacks! üé≤ ${hitRoll} vs ${playerDodge}`, 'system');
                addCombatLog(`You take <span class="dice-roll">${damage}</span> damage!${defended ? ' (defended)' : ''}`, 'combat');
            } else {
                addCombatLog(`${currentEnemy.icon} attacks but you dodge! üé≤ ${hitRoll} vs ${playerDodge}`, 'loot');
            }
        }
        
        function combatTurn(action) {
            // Check if enemy is stunned
            const enemyStunned = currentEnemy.stunned;
            if (enemyStunned) currentEnemy.stunned = false;
            
            switch(action) {
                case 'combat_attack':
                    playerAttack();
                    if (currentEnemy.hp > 0 && !enemyStunned) enemyAttack();
                    break;
                case 'combat_defend':
                    addCombatLog('You brace for the attack...', 'system');
                    if (!enemyStunned) enemyAttack(true);
                    else addCombatLog('Enemy is stunned!', 'loot');
                    break;
                case 'combat_special':
                    useSpecialAbility();
                    if (currentEnemy.hp > 0 && !enemyStunned && !player.classData.special.stun) enemyAttack();
                    break;
                case 'combat_bandage':
                    player.inventory = player.inventory.filter(i => i !== 'bandage');
                    player.hp = Math.min(player.maxHp, player.hp + 20);
                    addCombatLog('ü©π You use a bandage! +20 HP', 'loot');
                    playSound('coin');
                    if (!enemyStunned) enemyAttack();
                    break;
                case 'combat_whiskey':
                    player.inventory = player.inventory.filter(i => i !== 'whiskey');
                    player.hp = Math.min(player.maxHp, player.hp + 15);
                    player.str += 2;
                    addCombatLog('ü•É Whiskey! +15 HP, +2 STR!', 'loot');
                    playSound('coin');
                    if (!enemyStunned) enemyAttack();
                    break;
                case 'combat_dynamite':
                    player.inventory = player.inventory.filter(i => i !== 'dynamite');
                    currentEnemy.hp -= 40;
                    addCombatLog('üß® BOOM! 40 damage!', 'combat');
                    playSound('hit');
                    if (currentEnemy.hp > 0 && !enemyStunned) enemyAttack();
                    break;
            }
            
            updateCombatUI();
            
            // Check victory/defeat
            if (currentEnemy.hp <= 0) {
                endCombat(true);
            } else if (player.hp <= 0) {
                endCombat(false);
            } else {
                showCombatChoices();
            }
        }
        
        function endCombat(victory) {
            inCombat = false;
            combatArea.classList.remove('visible');
            
            if (victory) {
                player.kills++;
                playSound('victory');
                const goldEarned = currentEnemy.gold + rollDice(10);
                player.gold += goldEarned;
                
                // Reputation gain for defeating outlaws
                if (['bandit', 'outlaw', 'desperado'].includes(currentEnemy.name?.toLowerCase())) {
                    player.reputation += 5;
                    addStory('system', '‚≠ê Reputation +5 (brought outlaw to justice)');
                }
                
                updateStats();
                
                addStory('loot', `üèÜ Victory! You defeated the ${currentEnemy.name}!`);
                addStory('loot', `+${goldEarned} gold earned!`);
                
                // Check for boss victory - Show epic ending
                if (currentEnemy.name === 'Gang Leader') {
                    player.gold += 100; // Bounty
                    player.reputation += 50;
                    updateStats();
                    addStory('loot', `üí∞ BOUNTY COLLECTED: +$100 gold!`);
                    addStory('system', '‚≠ê Reputation +50 (legendary feat!)');
                    showScene('ending');
                    return;
                }
                
                showChoices([
                    { text: 'üè† Return to town', action: 'intro' },
                    { text: 'üèúÔ∏è Continue exploring', action: 'wilderness' }
                ]);
            } else {
                playSound('death');
                showGameOver(false);
            }
        }
        
        function showGameOver(victory) {
            gameOverEl.classList.add('visible');
            if (victory) {
                gameOverEl.classList.add('victory');
                document.getElementById('go-title').textContent = 'üèÜ VICTORY!';
                document.getElementById('go-message').textContent = `${player.name} the ${player.classData.name} has become a legend of the West!`;
            } else {
                document.getElementById('go-title').textContent = 'üíÄ GAME OVER';
                document.getElementById('go-message').textContent = `${player.name} met their end in the dusty frontier...`;
            }
            document.getElementById('go-stats').innerHTML = `
                Gold: ${player.gold}<br>
                Enemies Defeated: ${player.kills}<br>
                Days Survived: ${gameDay}
            `;
        }
        
        // Handle choice for both story and combat
        function handleChoice(action) {
            if (action.startsWith('combat_')) {
                combatTurn(action);
            } else if (SCENES[action]) {
                showScene(action);
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            const num = parseInt(e.key);
            if (num >= 1 && num <= 9) {
                const buttons = choicesArea.querySelectorAll('.choice-btn:not([disabled])');
                if (buttons[num - 1]) {
                    buttons[num - 1].click();
                }
            }
        });
        
        // Start!
        startGame();
    </script>
</body>
</html>
